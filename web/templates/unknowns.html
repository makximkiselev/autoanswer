<!DOCTYPE html>
<html>
<head>
    <title>–ù–µ–º–æ–¥–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</title>
    <meta charset="UTF-8" />
    <style>
        body { font-family: sans-serif; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 2em; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f5f5f5; }
        .confirm-btn {
            background-color: #d4edda;
            color: #155724;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
        }
        .confirm-btn.confirmed {
            background-color: #28a745;
            color: white;
        }
        .add-product-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
        }
        input[type="text"], select {
            width: 100%;
            padding: 6px;
            box-sizing: border-box;
        }
        #modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        #modal-content {
            background: white;
            width: 400px;
            margin: 100px auto;
            padding: 20px;
            border-radius: 10px;
            position: relative;
        }
        #modal-content button.close {
            position: absolute;
            top: 10px;
            right: 10px;
            border: none;
            background: transparent;
            font-size: 20px;
            cursor: pointer;
        }
        #load-more {
            display: block;
            margin: 1.5em auto;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<h1>üß† –ù–µ–º–æ–¥–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
    <form method="post" action="/unknowns/clear-unmatched" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏?');" style="display:inline;">
        <button style="margin-left: 20px; background-color: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">üßπ –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </form>
</h1>
<form action="/unknowns/approve" method="post" onsubmit="collectFormData()">
    <table>
        <thead>
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ü–æ–∏—Å–∫ –º–æ–¥–µ–ª–∏</th>
                <th>–ü—Ä–∏–≤—è–∑–∫–∞</th>
                <th>–†–µ–≥–∏–æ–Ω</th>
                <th>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</th>
                <th>–ò—Å–∫–ª—é—á–∏—Ç—å</th>
            </tr>
        </thead>
        <tbody id="unknowns-table-body">
            <!-- –°—é–¥–∞ –±—É–¥—É—Ç –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ JS -->
        </tbody>
    </table>
    <input type="hidden" name="approved_ids" id="approved_ids">
    <input type="hidden" name="model_ids" id="model_ids">
    <button type="submit">üìÇ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</form>
<button id="load-more" onclick="loadMore()">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë</button>

<nav style="margin-top: 2em;">
    <a href="/">üè† –ì–ª–∞–≤–Ω–∞—è</a>
    <a href="/matrix" style="margin-left: 1em;">üìä –ü—Ä–∞–π—Å-–º–∞—Ç—Ä–∏—Ü–∞</a>
</nav>

<!-- –ú–æ–¥–∞–ª–∫–∞ -->
<div id="modal">
    <div id="modal-content">
        <button class="close" onclick="closeModal()">&times;</button>
        <h3>–°–æ–∑–¥–∞—Ç—å –∏ –ø—Ä–∏–≤—è–∑–∞—Ç—å —Ç–æ–≤–∞—Ä</h3>
        <form action="/unknowns/create-and-confirm" method="post">
            <input type="hidden" name="unmatched_id" id="modal_unmatched_id" />
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:<br>
                <select name="category_id" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                    {% for cat in categories %}
                        <option value="{{ cat[0] }}">{{ cat[1] }}</option>
                    {% endfor %}
                </select>
            </label><br><br>
            <label>–ë—Ä–µ–Ω–¥:<br>
                <input name="brand_name" list="brands-list" required>
                <datalist id="brands-list">
                    {% for brand in brands %}
                        <option value="{{ brand[0] }}">
                    {% endfor %}
                </datalist>
            </label><br><br>
            <label>–ú–æ–¥–µ–ª—å:<br>
                <input name="model_name" list="models-list" required>
                <datalist id="models-list">
                    {% for model in models %}
                        <option value="{{ model[0] }}">
                    {% endfor %}
                </datalist>
            </label><br><br>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:<br>
                <input type="text" name="product_name" required>
            </label><br><br>
            <label>–†–µ–≥–∏–æ–Ω:<br>
                <input name="region_code" list="regions-list">
                <datalist id="regions-list">
                    {% for region in regions %}
                        <option value="{{ region.code }}">{{ region.flag or '' }} {{ region.name }}</option>
                    {% endfor %}
                </datalist>
            </label><br><br>
            <button type="submit">üíæ –°–æ–∑–¥–∞—Ç—å –∏ –ø—Ä–∏–≤—è–∑–∞—Ç—å</button>
        </form>
    </div>
</div>

<script>
let currentPage = 1;

function loadMore() {
    fetch(`/unknowns/api/rows?page=${currentPage}`)
        .then(res => res.text())
        .then(html => {
            document.getElementById('unknowns-table-body').insertAdjacentHTML('beforeend', html);
            currentPage++;
        });
}

window.addEventListener('DOMContentLoaded', () => {
    loadMore(); // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—É—é –ø–æ—Ä—Ü–∏—é —Å—Ä–∞–∑—É
});

function searchModel(input, listId) {
    const query = input.value.trim();
    const list = document.getElementById(listId);
    list.innerHTML = '';
    if (query.length < 2) return;
    fetch(`/api/catalog/search?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(items => {
            for (const item of items) {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.textContent = item.name;
                list.appendChild(opt);
            }
            const confirmBtn = input.closest("tr").querySelector(".confirm-btn");
            confirmBtn.disabled = false;
        })
        .catch(() => {
            const confirmBtn = input.closest("tr").querySelector(".confirm-btn");
            confirmBtn.disabled = true;
        });
}

function confirmProduct(button) {
    button.textContent = "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ";
    button.classList.add("confirmed");
    button.disabled = true;
}

function openModal(id) {
    document.getElementById("modal_unmatched_id").value = id;
    document.getElementById("modal").style.display = "block";
}

function closeModal() {
    document.getElementById("modal").style.display = "none";
}

function collectFormData() {
    const rows = document.querySelectorAll('tbody tr');
    const approvedIds = [];
    const modelPairs = [];
    rows.forEach(row => {
        const btn = row.querySelector(".confirm-btn.confirmed");
        const sel = row.querySelector("select[name^='model_select_']");
        if (btn && sel && sel.value) {
            const id = sel.name.replace('model_select_', '');
            approvedIds.push(id);
            modelPairs.push(`${id}:${sel.value}`);
        }
    });
    document.getElementById('approved_ids').value = approvedIds.join(',');
    document.getElementById('model_ids').value = modelPairs.join(',');
}
</script>
</body>
</html>
