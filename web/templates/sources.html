<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Telegram –∏—Å—Ç–æ—á–Ω–∏–∫–∏</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, select, button { margin: 5px; padding: 5px; }
    table { border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    #parserStatus { display: none; margin-left: 10px; color: green; }
    #parserError { display: none; margin-left: 10px; color: red; }
  </style>
  <script>
    async function handleParserStart(e) {
      e.preventDefault();
      const button = document.getElementById('parserButton');
      const status = document.getElementById('parserStatus');
      const error = document.getElementById('parserError');
      button.disabled = true;
      status.style.display = 'inline';
      error.style.display = 'none';

      try {
        const response = await fetch('/run-parser');
        if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞");
        const result = await response.text();
        status.innerText = '‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω';
        setTimeout(() => {
          button.disabled = false;
          status.style.display = 'none';
          status.innerText = '‚è≥ –ü–∞—Ä—Å–∏–Ω–≥...';
        }, 5000);
      } catch (err) {
        error.innerText = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–∞—Ä—Å–µ—Ä–∞';
        error.style.display = 'inline';
        button.disabled = false;
        status.style.display = 'none';
      }
    }
  </script>
</head>
<body>
  <h1>–°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</h1>

  <p>
    <a href="/" style="margin-right: 20px;">‚¨ÖÔ∏è –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    <form method="get" onsubmit="handleParserStart(event);" style="display:inline;">
      <button id="parserButton" type="submit">üîÅ –°–æ–±—Ä–∞—Ç—å –ø—Ä–∞–π—Å</button>
      <span id="parserStatus">‚è≥ –ü–∞—Ä—Å–∏–Ω–≥...</span>
      <span id="parserError"></span>
    </form>
  </p>

  {% if status == 'ok' %}
    <p style="color: green;">‚úÖ –ò—Å—Ç–æ—á–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!</p>
  {% elif status == 'exists' %}
    <p style="color: orange;">‚ö†Ô∏è –¢–∞–∫–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.</p>
  {% elif status == 'fail' %}
    <p style="color: red;">‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞.</p>
  {% elif status == 'error' %}
    <p style="color: red;">üî• –°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞.</p>
  {% endif %}

  <form action="/sources/form" method="post">
    <input type="text" name="name" placeholder="–ò–º—è –∫–∞–Ω–∞–ª–∞ –∏–ª–∏ —á–∞—Ç–∞" required>
    <label><input type="checkbox" name="monitored" checked> –°–ª—É—à–∞—Ç—å</label>
    <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
  </form>
  <!-- ‚ö†Ô∏è –¢–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ -->

  {% if matches %}
    <h3>üîç –ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π:</h3>
    <ul>
      {% for m in matches %}
        <li><b>{{ m.name }}</b> ({{ m.type }}, ID: {{ m.id }})
          <form method="post" action="/sources/confirm-source" style="display:inline;">
            <input type="hidden" name="name" value="{{ name }}">
            <input type="hidden" name="type" value="{{ m.type }}">
            <input type="hidden" name="channel_id" value="{{ m.id }}">
            <input type="hidden" name="monitored" value="{{ 'on' if monitored else '' }}">
            <input type="hidden" name="account_id" value="{{ m.account_id }}">
            <button type="submit">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
          </form>
        </li>
      {% endfor %}
    </ul>
  {% endif %}

  <h2>üì¢ –ö–∞–Ω–∞–ª—ã</h2>
  <ul>
    {% for row in sources %}
      {% if row.type == 'channel' %}
        <li><b>{{ row.name }}</b> (ID: {{ row.channel_id }}) ‚Äî {{ 'üü¢ —Å–ª—É—à–∞–µ—Ç—Å—è' if row.monitored else 'üî¥ –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è' }}
          <form style="display:inline;" method="post" action="/sources/{{ row.id }}/toggle">
            <button type="submit">{{ '–í—ã–∫–ª—é—á–∏—Ç—å' if row.monitored else '–í–∫–ª—é—á–∏—Ç—å' }}</button>
          </form>
          <form style="display:inline;" method="post" action="/sources/delete/{{ row.id }}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å?');">
            <button type="submit">–£–¥–∞–ª–∏—Ç—å</button>
          </form>
        </li>
      {% endif %}
    {% endfor %}
  </ul>

  <h2>üí¨ –ß–∞—Ç—ã —Å —Ü–µ–Ω–∞–º–∏</h2>
  <ul>
    {% for row in sources %}
      {% if row.type == 'chat_prices' %}
        <li><b>{{ row.name }}</b> (ID: {{ row.channel_id }}) ‚Äî {{ 'üü¢ —Å–ª—É—à–∞–µ—Ç—Å—è' if row.monitored else 'üî¥ –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è' }}
          ...
        </li>
      {% endif %}
    {% endfor %}
  </ul>

  <h2>üì® –ß–∞—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏</h2>
  <ul>
    {% for row in sources %}
      {% if row.type == 'chat_messages' %}
        <li><b>{{ row.name }}</b> (ID: {{ row.channel_id }}) ‚Äî {{ 'üü¢ —Å–ª—É—à–∞–µ—Ç—Å—è' if row.monitored else 'üî¥ –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è' }}
          ...
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  <hr>

  <table id="sourceTable">
    <thead>
      <tr><th>ID</th><th>–ò–º—è</th><th>–¢–∏–ø</th><th>–°–ª—É—à–∞—Ç—å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
    </thead>
    <tbody>
      {% for row in sources %}
        <tr>
          <td>{{ row.channel_id }}</td>
          <td>{{ row.name }}</td>
          <td>{{ row.type }}</td>
          <td>{{ '‚úÖ' if row.monitored else '‚ùå' }}</td>
          <td>
            <form style="display:inline;" method="post" action="/sources/{{ row.id }}/toggle">
              <button type="submit">{{ '–í—ã–∫–ª—é—á–∏—Ç—å' if row.monitored else '–í–∫–ª—é—á–∏—Ç—å' }}</button>
            </form>
            <form style="display:inline;" method="post" action="/sources/delete/{{ row.id }}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å?');">
              <button type="submit">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</body>
</html>