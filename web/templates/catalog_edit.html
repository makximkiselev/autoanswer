<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³Ð°</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 40px; background: #f9f9f9; }
    h1 { font-size: 1.6em; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tabs button { padding: 8px 16px; background: #ddd; border: none; cursor: pointer; border-radius: 4px; }
    .tabs button.active { background: #333; color: #fff; }
    .view-container { display: none; }
    .view-container.active { display: block; }
    .section { display: flex; gap: 20px; }
    .column { background: #fff; border: 1px solid #ccc; border-radius: 6px; padding: 12px; width: 30%; min-height: 200px; }
    .column h3 { margin-top: 0; font-size: 1.1em; }
    .item { padding: 6px 10px; margin-bottom: 5px; background: #f0f0f0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
    .item-name { flex: 1; cursor: pointer; }
    .item.active .item-name { color: #007bff; font-weight: bold; }
    .inline-form { margin-top: 10px; display: flex; gap: 5px; }
    .inline-form input, .inline-form select { flex: 1; padding: 4px 8px; }
    .inline-form button { padding: 4px 10px; background: #333; color: #fff; border: none; cursor: pointer; }
    .icon-button { background: transparent; border: none; cursor: pointer; font-size: 1em; margin-left: 4px; }
    #toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: 1000;
    }
    #toast.show { opacity: 1; }
    .drag-over {
      outline: 2px dashed #007bff;
      background-color: #e6f2ff;
    }
  </style>
</head>
<body>
<h1>ðŸ“‚ Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³Ð°</h1>

<script id="catalog-data" type="application/json">
{
  "categories": {{ categories|tojson }},
  "brands": {{ brands|tojson }},
  "models": {{ models|tojson }}
}
</script>
<script>
  const data = JSON.parse(document.getElementById('catalog-data').textContent);
  window.categories = data.categories;
  window.brands = data.brands;
  window.models = data.models;
</script>

<div id="toast"></div>

<div class="tabs">
  <button class="tab-button active" data-tab="categories">ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸</button>
  <button class="tab-button" data-tab="brands">Ð‘Ñ€ÐµÐ½Ð´Ñ‹</button>
  <button class="tab-button" data-tab="models">ÐœÐ¾Ð´ÐµÐ»Ð¸</button>
</div>

<div class="view-container active" id="tab-categories">
  <div class="section">
  <div class="column" id="category-list">
    <h3>ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ <button onclick="addCategory()">âž•</button></h3>
    <div id="categories"></div>
  </div>
  <div class="column" id="subcategory-list">
    <h3>ÐŸÐ¾Ð´ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ <button onclick="addSubcategory()">âž•</button></h3>
    <div id="subcategories"></div>
  </div>
  <div class="column" id="brand-list">
    <h3>Ð‘Ñ€ÐµÐ½Ð´Ñ‹ <button id="add-brand-button" disabled onclick="addBrandToCategory()">âž•</button></h3>
    <div id="brands"></div>
  </div>
  <div class="column" id="model-list-inline">
    <h3>ÐœÐ¾Ð´ÐµÐ»Ð¸ <button id="add-model-button" disabled onclick="addModelToSelectedBrand()">âž•</button></h3>
    <div id="inline-models"></div>
  </div>
    </div>
  </div>
</div>

<!-- Ð”ÐžÐ‘ÐÐ’Ð›Ð•ÐÐž: Ð±Ð»Ð¾Ðº Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ -->
<div class="view-container" id="tab-brands">
  <div class="section">
    <div class="column" id="brand-directory">
      <h3>Ð¡Ð¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸Ðº Ð±Ñ€ÐµÐ½Ð´Ð¾Ð² <button onclick="addGlobalBrand()">âž•</button></h3>
      <div id="brand-global-list"></div>
    </div>
  </div>
</div>

<div class="view-container" id="tab-models">
  <div class="section">
    <div class="column" id="model-list">
      <h3>ÐœÐ¾Ð´ÐµÐ»Ð¸ <button onclick="addModelToBrand()">âž•</button></h3>
      <div id="models"></div>
    </div>
  </div>
</div>

<!-- ðŸ‘‡ JS Ð´Ð»Ñ Ð»Ð¾Ð³Ð¸ÐºÐ¸ -->
<script src="/static/js/catalog-edit.js"></script>

<!-- ðŸ‘‡ ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð²ÐºÐ»Ð°Ð´Ð¾Ðº -->
<script>
  document.querySelectorAll('.tab-button').forEach(function(btn) {
    btn.addEventListener('click', function() {
      switchTab(btn.dataset.tab);
    });
  });

  function addModelToBrand() {
    const container = document.getElementById('models');
    const form = document.createElement('div');
    form.className = 'inline-form';
    form.innerHTML = '<input type="text" placeholder="ÐÐ¾Ð²Ð°Ñ Ð¼Ð¾Ð´ÐµÐ»ÑŒ">' +
      '<select id="brand-select">' +
      (window.brands || []).map(function(b) {
        return '<option value="' + b.id + '">' + b.name + '</option>';
      }).join('') +
      '</select>' +
      '<button>ðŸ“‹</button>';

    form.querySelector('button').onclick = function() {
      const name = form.querySelector('input').value.trim();
      const brand_id = form.querySelector('select').value;
      if (!name || !brand_id) return;
      fetch('/catalog/edit/add-model', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ name: name, brand_id: brand_id })
      }).then(function() {
        showToast('ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð°');
        renderModels();
      });
    };
    container.prepend(form);
  }

  function renderModels() {
    const container = document.getElementById('models');
    container.innerHTML = '';
    (window.models || []).forEach(function(m) {
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = '<span class="item-name">' + m.name + '</span>';
      container.appendChild(el);
    });
  }
  document.addEventListener('DOMContentLoaded', function () {
    const addBrandBtn = document.getElementById('add-brand-button');
    const addModelBtn = document.getElementById('add-model-button');

    window.enableBrandAndModelInputs = function () {
      const hasSub = window.categories.some(c => c.parent_id === activeCategoryId);
      addBrandBtn.disabled = !activeSubcategoryId && hasSub;
      addModelBtn.disabled = !activeSubcategoryId || !activeBrandId;
    };

    window.selectCategory = (id, el) => {
      activeCategoryId = id;
      activeSubcategoryId = null;
      activeBrandId = null;
      document.querySelectorAll('#categories .item').forEach(i => i.classList.remove('active'));
      if (el && el.closest('.item')) el.closest('.item').classList.add('active');

      const tree = buildCategoryTree(window.categories, id, 1);
      renderTree(document.getElementById('subcategories'), tree, selectSubcategory);

      fetch(`/catalog/brands/${id}`).then(r => r.json()).then(data => {
        renderList('brands', data.brands, selectBrand);
      });
      enableBrandAndModelInputs();
    };

    window.selectSubcategory = (id, el) => {
      activeSubcategoryId = id;
      activeBrandId = null;
      document.querySelectorAll('#subcategories .item').forEach(i => i.classList.remove('active'));
      if (el && el.closest('.item')) el.closest('.item').classList.add('active');

      fetch(`/catalog/brands/${id}`).then(r => r.json()).then(data => {
        renderList('brands', data.brands, selectBrand);
      });
      enableBrandAndModelInputs();
    };

    window.selectBrand = (id, el) => {
      activeBrandId = id;
      document.querySelectorAll('#brands .item').forEach(i => i.classList.remove('active'));
      if (el && el.closest('.item')) el.closest('.item').classList.add('active');
      enableBrandAndModelInputs();
    };

    window.addModelToSelectedBrand = () => {
      if (!activeBrandId) return;
      const container = document.getElementById('inline-models');
      const form = document.createElement('div');
      form.className = 'inline-form';
      form.innerHTML = '<input type="text" placeholder="ÐÐ¾Ð²Ð°Ñ Ð¼Ð¾Ð´ÐµÐ»ÑŒ"><button>ðŸ“‹</button>';
      form.querySelector('button').onclick = () => {
        const name = form.querySelector('input').value.trim();
        if (!name) return;
        fetch('/catalog/edit/add-model', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ name, brand_id: activeBrandId })
        }).then(() => {
          showToast('ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð°');
          renderModels();
        });
      };
      container.prepend(form);
    };
  });
  function addGlobalBrand() {
    const container = document.getElementById('brand-global-list');
    const form = document.createElement('div');
    form.className = 'inline-form';
    form.innerHTML = '<input type="text" placeholder="ÐÐ¾Ð²Ñ‹Ð¹ Ð±Ñ€ÐµÐ½Ð´"><button>ðŸ“‹</button>';
    form.querySelector('button').onclick = () => {
      const name = form.querySelector('input').value.trim().toLowerCase();
      if (!name) return;
      const exists = (window.brands || []).some(b => b.name.toLowerCase() === name);
      if (exists) {
        showToast('Ð¢Ð°ÐºÐ¾Ð¹ Ð±Ñ€ÐµÐ½Ð´ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚');
        return;
      }
      fetch('/catalog/edit/add-brand', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ name: name })
      })
      .then(res => res.json())
      .then(newBrand => {
        showToast('Ð‘Ñ€ÐµÐ½Ð´ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½');
        if (!window.brands) window.brands = [];
        window.brands.push(newBrand);
        renderGlobalBrands();
      });
    };
    container.prepend(form);
  }

  function renderGlobalBrands() {
    const container = document.getElementById('brand-global-list');
    container.innerHTML = '';
    (window.brands || []).forEach(b => {
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = '<span class="item-name">' + b.name + '</span>';
      container.appendChild(el);
    });
  }

  function switchTab(tab) {
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    document.querySelectorAll('.view-container').forEach(c => {
      c.classList.toggle('active', c.id === 'tab-' + tab);
    });
    if (tab === 'brands') renderGlobalBrands();
    if (tab === 'models') renderModels();
  }
</script>
</body>
</html>
